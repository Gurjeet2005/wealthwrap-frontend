<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals - WealthWrap</title>
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
</head>

<body>
    <div class="app-layout">
        <main class="main-content">
            <div class="container">
                <div class="container-flex mb-4">
                    <h1>Your Financial Goals</h1>
                    <button id="add-goal-btn" class="btn btn-primary">+ New Goal</button>
                </div>

                <div id="goals-grid" class="grid grid-cols-2">
                    <!-- Goals injected here -->
                    <div class="card text-center text-muted">Loading goals...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Goal Modal -->
    <div id="goal-modal" class="hidden" role="dialog" aria-modal="true">
        <div
            style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div class="card" style="width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <div class="container-flex mb-4">
                    <h3>Create New Goal</h3>
                    <button id="close-modal"
                        style="background:none; border:none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <form id="goal-form">
                    <div class="form-group">
                        <label class="form-label">Goal Title</label>
                        <input type="text" name="title" class="form-input" required placeholder="e.g. New Car">
                    </div>
                    <div class="grid grid-cols-2" style="gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Target Amount (₹)</label>
                            <input type="number" name="targetAmount" class="form-input" required min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Saved (₹)</label>
                            <input type="number" name="currentSaved" class="form-input" value="0" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Date</label>
                        <input type="date" name="deadline" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Contribution (₹)</label>
                        <input type="number" name="contribution" class="form-input" required min="0">
                        <p class="form-hint" id="forecast-hint">Estimated completion: --</p>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%">Save Goal</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { Auth } from '../js/auth.js';
        import { UI } from '../js/ui.js';
        import { API } from '../js/api.js';

        Auth.requireAuth();
        UI.mountHeader();
        UI.mountSidebar();

        const user = Auth.currentUser();
        const goalsGrid = document.getElementById('goals-grid');
        const modal = document.getElementById('goal-modal');
        const form = document.getElementById('goal-form');

        // Modal Logic
        document.getElementById('add-goal-btn').addEventListener('click', () => {
            modal.classList.remove('hidden');
            form.querySelector('input').focus();
        });
        document.getElementById('close-modal').addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Forecast Logic
        const contributionInput = form.querySelector('[name="contribution"]');
        const targetInput = form.querySelector('[name="targetAmount"]');
        const currentInput = form.querySelector('[name="currentSaved"]');

        function updateForecast() {
            const target = parseFloat(targetInput.value) || 0;
            const current = parseFloat(currentInput.value) || 0;
            const monthly = parseFloat(contributionInput.value) || 0;

            if (target > current && monthly > 0) {
                const months = Math.ceil((target - current) / monthly);
                const date = new Date();
                date.setMonth(date.getMonth() + months);
                document.getElementById('forecast-hint').textContent = `Estimated completion: ${date.toLocaleDateString()}`;
            } else {
                document.getElementById('forecast-hint').textContent = 'Enter valid amounts to see forecast';
            }
        }
        form.addEventListener('input', updateForecast);

        // Save Goal
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button[type="submit"]');
            UI.setLoading(btn, true);

            const formData = new FormData(form);
            const goal = {
                userId: user.id,
                title: formData.get('title'),
                targetAmount: parseFloat(formData.get('targetAmount')),
                currentSaved: parseFloat(formData.get('currentSaved')),
                deadline: formData.get('deadline'),
                contribution: parseFloat(formData.get('contribution')),
                color: '#2B6CB0' // default
            };

            await API.saveGoal(goal);
            UI.toast('Goal saved successfully!');
            modal.classList.add('hidden');
            form.reset();
            UI.setLoading(btn, false);
            loadGoals();
        });

        // Render Goals
        async function loadGoals() {
            try {
                const goals = await API.getGoals(user.id);
                goalsGrid.innerHTML = '';

                if (goals.length === 0) {
                    goalsGrid.innerHTML = `<div class="card text-center text-muted" style="grid-column: 1/-1;">No goals yet. Create one!</div>`;
                    return;
                }

                goals.forEach(goal => {
                    const percent = Math.min(100, Math.round((goal.currentSaved / goal.targetAmount) * 100));

                    const el = UI.createElement('div', ['card']);
                    el.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <h3>${goal.title}</h3>
                            <span class="badge badge-info">${goal.deadline}</span>
                        </div>
                        <div style="margin: 1rem 0;">
                            <div style="display:flex; justify-content:space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                <span>${UI.formatCurrency(goal.currentSaved)}</span>
                                <span class="text-muted">of ${UI.formatCurrency(goal.targetAmount)}</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${percent}%"></div>
                            </div>
                        </div>
                        <div style="display:flex; justify-content: end;">
                            <button class="btn btn-sm btn-outline">Edit</button>
                        </div>
                    `;
                    goalsGrid.appendChild(el);
                });
            } catch (e) {
                console.error(e);
            }
        }

        loadGoals();
    </script>
</body>

</html>